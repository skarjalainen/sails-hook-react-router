This is far from finished but does work in general, undocumented unfortunately. 
